'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = ejsHtmlLoader;

var _loaderUtils = require('loader-utils');

var _cache = require('./cache');

var _render2 = require('./render');

function ejsHtmlLoader(src) {
  this.cacheable();
  var rendered = '';

  try {
    rendered = renderTemplate(this, src);
  } catch (e) {
    emitError(this, e.message);
  }

  return rendered;
}

function renderTemplate(ctx, src) {
  var data = getData(ctx);

  var _render = (0, _render2.render)(ctx, src, data),
      rendered = _render.rendered,
      deps = _render.deps;

  (0, _cache.saveDependencies)(ctx, deps);

  return rendered;
}

function getData(ctx) {
  return Object.assign({}, (0, _loaderUtils.getOptions)(ctx), getResourceQuery(ctx));
}

function getResourceQuery(ctx) {
  return (0, _loaderUtils.parseQuery)(ctx.resourceQuery || "?");
}

function emitError(ctx, msg) {
  (0, _cache.addDependencies)(ctx);
  ctx.emitError('ejs-html-loader\n' + msg);
}
module.exports = exports.default;