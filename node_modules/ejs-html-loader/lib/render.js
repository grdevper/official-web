'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.render = render;

var _fs = require('fs');

var _ejs = require('ejs');

function render(ctx, src, data) {
  var filename = ctx.resourcePath;
  var delimiter = data.delimiter;
  var context = data.context;

  var tpl = (0, _ejs.compile)(src, { filename: filename, delimiter: delimiter, context: context });

  return {
    rendered: tpl(data),
    deps: getDeps(tpl.dependencies, { delimiter: delimiter, context: context })
  };
}

function getDeps(deps, opts) {
  var result = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];

  deps.forEach(function (name) {
    result.push(name);
    getDeps(getOwnDeps(name, opts), opts, result);
  });

  return result;
}

function getOwnDeps(filename, _ref) {
  var delimiter = _ref.delimiter,
      context = _ref.context;

  var src = (0, _fs.readFileSync)(filename, 'utf8');
  var tpl = (0, _ejs.compile)(src, { filename: filename, delimiter: delimiter, context: context });
  return tpl.dependencies;
}